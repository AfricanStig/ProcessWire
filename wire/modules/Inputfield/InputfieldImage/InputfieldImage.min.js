function InputfieldImage(f){var p=null;var c={file:"",item:null,edit:null};var v={type:"image",closeOnContentClick:true,closeBtnInside:true};function a(){var C=window.File&&window.FileList&&window.FileReader;var B=f(".InputfieldAllowAjaxUpload").length>0;var D=f("#PageIDIndicator").length>0;return(C&&(D||B))}function i(D,B,C){B||(B=250);var E,F;return function(){var I=C||this;var H=+new Date(),G=arguments;if(E&&H<E+B){clearTimeout(F);F=setTimeout(function(){E=H;D.apply(I,G)},B)}else{E=H;D.apply(I,G)}}}function j(C,B){return !B}function y(B){if(B.hasClass("ui-sortable")){B.sortable("destroy");B.children("li").each(function(D){var C=f(this).find("input.InputfieldFileSort");C.val(D)})}B.sortable({items:"> .gridImage",start:function(D,C){C.placeholder.append(f("<div/>").css({display:"block",height:B.data("gridsize")+"px",width:B.data("gridsize")+"px"}));timer=window.setTimeout(function(){e(B,null)},100);B.addClass("InputfieldImageSorting")},stop:function(D,C){$this=f(this);if(timer!==null){C.item.find(".InputfieldImageEdit__edit").click();clearTimeout(timer)}$this.children("li").each(function(E){f(this).find(".InputfieldFileSort").val(E)});C.item.find(".InputfieldFileSort").change();B.removeClass("InputfieldImageSorting")},cancel:".InputfieldImageEdit"})}function d(C){var B=v;B.callbacks={elementParse:function(D){var E=f(D.el).attr("data-original");if(typeof E=="undefined"||!E){E=f(D.el).attr("src")}D.src=E}};B.gallery={enabled:true};C.find("img").magnificPopup(B)}function r(C){var B=v;B.callbacks={elementParse:function(D){D.src=f(D.el).attr("src")}};B.gallery={enabled:false};C.find("img").magnificPopup(B)}function k(B){return B.find(".InputfieldImageEdit--active")}function o(B){return f("#"+B.find(".InputfieldImageEdit__edit").attr("data-current"))}function t(C){var B=C.children().first().outerWidth(true),D=C.width();C.attr("data-per-row",Math.floor(D/B))}function n(D){var B=D.is(":checked");var C=D.parents(".gridImages").find(".gridImage__deletebox");if(B){C.prop("checked","checked").change()}else{C.removeAttr("checked").change()}}var g=function(){var B=function(){var C=f(this),D=k(C);if(D.length){t(C);m(o(D),D)}};f(".gridImages").each(B)};function u(){g()}function w(B){if(B.is(":checked")){B.parents(".ImageOuter").addClass("gridImage--delete")}else{B.parents(".ImageOuter").removeClass("gridImage--delete")}}function A(B){B.parents(".gridImage").toggleClass("gridImage--delete");B.find("input").prop("checked",j)}function q(E,B){var D=B.find(".InputfieldImageEdit__image");var F=E.find("img");D.attr({src:F.attr("data-original"),"data-original":F.attr("data-original"),alt:F.attr("alt")});var C=v;C.callbacks={elementParse:function(G){G.src=f(G.el).attr("data-original")}};C.gallery={enabled:true};B.attr("id","edit-"+E.attr("id")).parents(".gridImages").find(".gridImage").not(E).find("img").add(D).magnificPopup(C);B.find(".InputfieldImageEdit__edit").attr("data-current",E.attr("id")).append(E.find(".ImageData").children().not(".InputfieldFileSort, .InputfieldFileReplace"))}function h(B){$inputArea=B.find(".InputfieldImageEdit__edit");if($inputArea.children().not(".InputfieldFileSort, .InputfieldFileReplace").length){f("#"+$inputArea.attr("data-current")).find(".ImageData").append($inputArea.children())}}function e(D,C){var B;if(D){B=D.find(".InputfieldImageEdit--active")}else{if(C){B=f(".InputfieldImageEdit--active").not(C.find(".InputfieldImageEdit--active"))}else{B=f(".InputfieldImageEdit--active")}}if(B.length){h(B);B.removeClass("InputfieldImageEdit--active").removeAttr("id");f("#"+B.attr("data-for")).removeClass("gridImageEditing")}f(".InputfieldImageEdit__replace").removeClass("InputfieldImageEdit__replace")}function m(G,C){if(!G||!G.length){return}t(G.parent());var B=G.parent().children().not(".InputfieldImageEdit"),H=parseInt(G.parent().attr("data-per-row")),D=B.index(G);for(var F=0;F<30;F++){if(D%H!==H-1){D++}else{continue}}D=Math.min(D,B.length-1);C.insertAfter(B.eq(D));var E=C.find(".InputfieldImageEdit__arrow");if(E.length){E.css("left",G.position().left+(G.outerWidth()/2)+"px")}}function z(){f(window).resize(i(u,200));f(document).on("click dblclick",".gridImage__trash",function(B){var C=f(this).find("input");C.prop("checked",j).change();if(B.type=="dblclick"){n(C)}});f(document).on("change",".gridImage__deletebox",function(){w(f(this))});f(document).on("click",".gridImage__edit",function(E){var C=f(this).closest(".gridImage");if(!C.length){return}var D=C.closest(".gridImages");var B=D.find(".InputfieldImageEdit");if(C.hasClass("gridImageEditing")){B.find(".InputfieldImageEdit__close").click()}else{m(C,B);h(B);q(C,B);B.addClass("InputfieldImageEdit--active").attr("data-for",C.attr("id"));D.find(".gridImageEditing").removeClass("gridImageEditing");C.addClass("gridImageEditing")}});f(document).on("click",function(C){var B=f(C.target);if(B.closest(".InputfieldImageEdit").length){e(null,B.parents(".gridImages"))}else{if(B.closest(".gridImage__inner").length){e(null,B.parents(".gridImages"))}else{if(B.closest(".mfp-container").length){return}else{if(B.closest(".ui-dialog").length){return}else{if(B.is(".mfp-close")){return}else{e(null,null)}}}}}});f(document).on("click",".InputfieldImageEdit__close",function(B){e(f(this).parents(".gridImages"),null)});f(document).on("change",".InputfieldImage",function(){f(this).find(".InputfieldImageButtonCrop").removeClass("pw-modal").addClass("ui-state-disabled")}).on("click",".InputfieldImageButtonCrop.ui-state-disabled",function(B){alert("This images field has changes. Please save them before cropping.");return false});f(".ImagesGrid").on("click","button.pw-modal",function(B){B.preventDefault()})}function l(B){var C=parseInt(B.find(".InputfieldImageMaxFiles").val());if(B.hasClass("InputfieldRenderValueMode")){return d(B)}else{if(C==1){B.addClass("InputfieldImageMax1");r(B)}else{y(B.find(".gridImages"))}}}function b(){f("body").addClass("ie-no-drop");f(".InputfieldImage.InputfieldFileMultiple").each(function(){var C=f(this),E=parseInt(C.find(".InputfieldFileMaxFiles").val()),B=C.find(".gridImages"),D=C.find(".InputfieldImageUpload");D.on("change","input[type=file]",function(){var I=f(this),G=I.parent(".InputMask");if(I.val().length>1){G.addClass("ui-state-disabled")}else{G.removeClass("ui-state-disabled")}if(I.next("input.InputfieldFile").length>0){return}var F=B.children("li").length+D.find("input[type=file]").length+1;if(E>0&&F>=E){return}D.find(".InputMask").not(":last").each(function(){var J=f(this);if(J.find("input[type=file]").val()<1){J.remove()}});var H=G.clone().removeClass("ui-state-disabled");H.children("input[type=file]").val("");H.insertAfter(G)})})}function x(D){var C;if(D.length>0){C=D.find(".InputfieldImageUpload")}else{C=f(".InputfieldImageUpload")}C.each(function(G){var H=f(this);var F=H.closest(".InputfieldContent");if(H.hasClass("InputfieldImageInit")){return}E(F,G);H.addClass("InputfieldImageInit")});function E(O,Z){var N=O.parents("form");var I=N.attr("action");I+=(I.indexOf("?")>-1?"&":"?")+"InputfieldFileAjax=1";var ad=N.find("input._post_token");var M=ad.attr("name");var R=ad.val();var Q=O.find(".InputfieldImageErrors").first();var H=O.find(".InputfieldImageUpload").data("fieldname");H=H.slice(0,-2);var Y=O.closest(".Inputfield.InputfieldImage");var ac=O.find(".InputfieldImageUpload").data("extensions").toLowerCase();var X=O.find(".InputfieldImageUpload").data("maxfilesize");var P=O.find("input[type=file]").get(0);var G=O.find(".gridImages");var aa=G.get(0);var T=G.data("gridsize");var U=null;var S=parseInt(O.find(".InputfieldImageMaxFiles").val());ab(O);if(S!=1){W(G)}L();G.children().addClass("InputfieldFileItemExisting");function L(){$dropHere=O.find(".AjaxUploadDropHere");$dropHere.show().click(function(){var ae=f(this).find(".InputfieldImageRefresh");if(ae.is(":visible")){ae.hide().siblings("span").show();f(this).find("input").val("0")}else{ae.show().siblings("span").hide();f(this).find("input").val("1")}})}function K(af,ae){if(typeof ae!=="undefined"){af="<b>"+ae+":</b> "+af}return"<li>"+af+"</li>"}function F(af){var ae=new String(af).substring(af.lastIndexOf("/")+1);if(ae.lastIndexOf(".")!=-1){ae=ae.substring(0,ae.lastIndexOf("."))}return ae}function ab(ae){if(ae.hasClass("InputfieldImageDropzoneInit")){return}var af=ae.get(0);af.addEventListener("dragleave",function(){ae.removeClass("ui-state-hover")},false);af.addEventListener("dragenter",function(){ae.addClass("ui-state-hover")},false);af.addEventListener("dragover",function(ag){if(!ae.is("ui-state-hover")){ae.addClass("ui-state-hover")}ag.preventDefault();ag.stopPropagation();return false},false);af.addEventListener("drop",function(ag){V(ag.dataTransfer.files);ae.removeClass("ui-state-hover");ag.preventDefault();ag.stopPropagation();return false},false);ae.addClass("InputfieldImageDropzoneInit")}function W(ak){var an=null;var am=false;var ae=null;function ah(ap){var au=ap.offset();var aq=ap.width();var ao=ap.height();var at=au.left+aq/2;var ar=au.top+ao/2;return{clientX:at,clientY:ar}}function aj(){return ak.find(".InputfieldImageEdit--active").length>0}function ai(ap){if(aj()){return}ap.preventDefault();ap.stopPropagation();am=false;if(an==null){var ao=ak.attr("data-gridsize")+"px";var aq=f("<div/>").addClass("gridImage__overflow").css({width:ao,height:ao});an=f("<li/>").addClass("ImageOuter gridImage gridImagePlaceholder").append(aq);ak.append(an)}var ar=ah(an);an.simulate("mousedown",ar)}function al(ao){if(aj()){return}ao.preventDefault();ao.stopPropagation();am=false;if(an==null){return}var ap={clientX:ao.originalEvent.clientX,clientY:ao.originalEvent.clientY};an.simulate("mousemove",ap)}function ag(ao){if(aj()){return}ao.preventDefault();ao.stopPropagation();if(an==null){return false}am=true;if(ae){clearTimeout(ae)}ae=setTimeout(function(){if(!am||an==null){return}an.remove();an=null},1000)}function af(ao){if(aj()){return}am=false;var ap={clientX:ao.clientX,clientY:ao.clientY};an.simulate("mouseup",ap);p=an.next(".gridImage");an.remove();an=null}if(ak.length&&!ak.hasClass("gridImagesInitDropInPlace")){ak.on("dragenter",ai);ak.on("dragover",al);ak.on("dragleave",ag);ak.on("drop",af);ak.addClass("gridImagesInitDropInPlace")}}function J(aw){var au=ProcessWire.config.InputfieldImage.labels;var ai=parseInt(aw.size/1024,10)+"&nbsp;kB";var av='<div class="gridImage__tooltip"><table><tbody><tr><th>'+au.dimensions+'</th><td class="dimensions">'+au.na+"</td></tr><tr><th>"+au.filesize+"</th><td>"+ai+"</td></tr><tr><th>"+au.variations+"</th><td>0</td></tr></tbody></table></div>";var ay=f('<li class="gridImage"></li>'),aq=f(av),ak=f('<div class="gridImage__overflow"></div>'),am=f('<img width="184" height="130" alt="">'),ae=f('<div class="ImageData"></div>'),ao=f("<div class='gridImage__hover'><div class='gridImage__inner'></div></div>"),ap=f("<progress class='gridImage__progress' min='-1' max='100' value='0'></progress>"),at=f('<a class="gridImage__edit" title="'+aw.name+'"><span>&nbsp;</span></a>'),ar=f('<div class="gridImage__resize"><i class="fa fa-spinner fa-spin fa-2x fa-fw"></i></div>'),az,af,al,ax,an=URL.createObjectURL(aw),ag=Y.find(".gridImages"),ah=S==1;ak.append(am);ao.find(".gridImage__inner").append(at);ao.find(".gridImage__inner").append(ar.css("display","none"));ao.find(".gridImage__inner").append(ap);ae.append(f('<h2 class="InputfieldImageEdit__name">'+aw.name+'</h2><span class="InputfieldImageEdit__info">'+ai+"</span>"));ak.css({width:T+"px",height:T+"px"});ay.append(aq).append(ak).append(ao).append(ae);am.attr({src:an,"data-original":an});az=new Image();az.addEventListener("load",function(){aq.find(".dimensions").html(this.width+"&nbsp;&times;&nbsp;"+this.height);var aA=Math.min(this.width,this.height)/T;am.attr({width:this.width/aA,height:this.height/aA})},false);az.src=an;al=new XMLHttpRequest();al.upload.addEventListener("progress",function(aA){if(!aA.lengthComputable){return}ap.attr("value",parseInt((aA.loaded/aA.total)*100));ar.css("display","block")},false);al.addEventListener("load",function(){var aB=f.parseJSON(al.responseText),aE=aB.length>1;if(aB.error!==undefined){aB=[aB]}for(var aG=0;aG<aB.length;aG++){var aD=aB[aG];if(aD.error){Q.append(K(aD.message));continue}var aA=null;var aC=f(aD.markup).hide();var aF=O.find("input[type=file]");if(aF.val()){aF.replaceWith(aF.clone(true))}if(aD.overwrite){aA=ag.children("#"+aC.attr("id"))}if(aD.replace||ah){aA=ag.children(".InputfieldImageEdit:eq(0)")}if(c.item&&aB.length==1&&!ah){aA=c.item}if(aA&&aA.length){aA.replaceWith(aC)}else{if(p&&p.length){p.before(aC);p=aC}else{if(aG===0){ay.replaceWith(aC)}else{ag.append(aC)}}}aC.fadeIn().css("display","");aC.addClass("InputfieldFileItemExisting");if(aA&&aA.length){aC.effect("highlight",500)}if(ay.length){ay.remove()}if(c.item&&!ah){aC.find(".gridImage__edit").click();aC.find(".InputfieldFileReplace").val(c.file)}c.file="";c.item=null;c.edit=null}if(U){clearTimeout(U)}p=null;U=setTimeout(function(){if(S!=1){y(ag)}else{r(Y)}ag.trigger("AjaxUploadDone")},500);Y.trigger("change")},false);if(c.edit){c.edit.find(".InputfieldImageEdit__close").click()}al.open("POST",I,true);al.setRequestHeader("X-FILENAME",encodeURIComponent(aw.name));al.setRequestHeader("X-FIELDNAME",H);al.setRequestHeader("Content-Type","application/octet-stream");al.setRequestHeader("X-"+M,R);al.setRequestHeader("X-REQUESTED-WITH","XMLHttpRequest");al.send(aw);if(c.item){c.item.replaceWith(ay);c.item=ay}else{if(p&&p.length){p.before(ay)}else{ag.append(ay)}}g();Y.trigger("change");var aj=Y.find(".InputfieldFileItem").length;if(aj==1){Y.removeClass("InputfieldFileEmpty").removeClass("InputfieldFileMultiple").addClass("InputfieldFileSingle")}else{if(aj>1){Y.removeClass("InputfieldFileEmpty").removeClass("InputfieldFileSingle").addClass("InputfieldFileMultiple")}}}function V(ai){var af=function(am){return parseInt(am/1024,10)};if(typeof ai==="undefined"){aa.innerHTML="No support for the File API in this web browser";return}for(var ag=0,ae=ai.length;ag<ae;ag++){var al=ai[ag].name.split(".").pop().toLowerCase();var ah;if(ac.indexOf(al)==-1){ah=al+" is a invalid file extension, please use one of:  "+ac;Q.append(K(ah,ai[ag].name))}else{if(ai[ag].size>X&&X>2000000){var ak=af(ai[ag].size),aj=af(X);ah="Filesize "+ak+" kb is too big. Maximum allowed is "+aj+" kb";Q.append(K(ah,ai[ag].name))}else{J(ai[ag])}}if(S==1){break}}}P.addEventListener("change",function(ae){V(this.files);ae.preventDefault();ae.stopPropagation();this.value=""},false)}function B(){var F=".InputfieldImageEdit__imagewrapper img";f(document).on("dragenter",F,function(){var I=f(this);if(I.closest(".InputfieldImageMax1").length){return}var J=I.attr("src");var G=I.closest(".InputfieldImageEdit");var H=I.closest(".InputfieldImageEdit__imagewrapper");H.addClass("InputfieldImageEdit__replace");c.file=new String(J).substring(J.lastIndexOf("/")+1);c.item=f("#"+G.attr("data-for"));c.edit=G}).on("dragleave",F,function(){var H=f(this);if(H.closest(".InputfieldImageMax1").length){return}var G=H.closest(".InputfieldImageEdit__imagewrapper");G.removeClass("InputfieldImageEdit__replace");c.file="";c.item=null;c.edit=null})}B()}function s(){f(".InputfieldImage.Inputfield").each(function(){l(f(this))});z();if(a()){x("")}else{b()}f(document).on("reloaded",".InputfieldImage",function(){var B=f(this);l(B);x(B)})}s()}jQuery(document).ready(function(a){InputfieldImage(a)});