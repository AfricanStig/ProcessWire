CKEDITOR.dialog.add("colordialog",function(A){function F(){N.getById(E).removeStyle("background-color");D.getContentElement("picker","selectedColor").setValue("");J&&J.removeAttribute("aria-selected");J=null}function s(d){var d=d.data.getTarget(),e;if("td"==d.getName()&&(e=d.getChild(0).getHtml())){J=d,J.setAttribute("aria-selected",!0),D.getContentElement("picker","selectedColor").setValue(e)}}function b(e){for(var e=e.replace(/^#/,""),f=0,d=[];2>=f;f++){d[f]=parseInt(e.substr(2*f,2),16)}return"#"+(165<=0.2126*d[0]+0.7152*d[1]+0.0722*d[2]?"000":"fff")}function i(e){!e.name&&(e=new CKEDITOR.event(e));var h=!/mouse/.test(e.name),d=e.data.getTarget(),f;if("td"==d.getName()&&(f=d.getChild(0).getHtml())){C(e),h?M=d:g=d,h&&(d.setStyle("border-color",b(f)),d.setStyle("border-style","dotted")),N.getById(I).setStyle("background-color",f),N.getById(H).setHtml(f)}}function C(d){if(d=!/mouse/.test(d.name)&&M){var e=d.getChild(0).getHtml();d.setStyle("border-color",e);d.setStyle("border-style","solid")}!M&&!g&&(N.getById(I).removeStyle("background-color"),N.getById(H).setHtml("&nbsp;"))}function a(f){var k=f.data,e=k.getTarget(),h=k.getKeystroke(),j="rtl"==A.lang.dir;switch(h){case 38:if(f=e.getParent().getPrevious()){f=f.getChild([e.getIndex()]),f.focus()}k.preventDefault();break;case 40:if(f=e.getParent().getNext()){(f=f.getChild([e.getIndex()]))&&1==f.type&&f.focus()}k.preventDefault();break;case 32:case 13:s(f);k.preventDefault();break;case j?37:39:if(f=e.getNext()){1==f.type&&(f.focus(),k.preventDefault(!0))}else{if(f=e.getParent().getNext()){if((f=f.getChild([0]))&&1==f.type){f.focus(),k.preventDefault(!0)}}}break;case j?39:37:if(f=e.getPrevious()){f.focus(),k.preventDefault(!0)}else{if(f=e.getParent().getPrevious()){f=f.getLast(),f.focus(),k.preventDefault(!0)}}}}var B=CKEDITOR.dom.element,N=CKEDITOR.document,L=A.lang.colordialog,D,c={type:"html",html:"&nbsp;"},J,M,g,G=function(d){return CKEDITOR.tools.getNextId()+"_"+d},I=G("hicolor"),H=G("hicolortext"),E=G("selhicolor"),K;(function(){function h(n,t){for(var o=n;o<n+3;o++){var r=new B(K.$.insertRow(-1));r.setAttribute("role","row");for(var q=t;q<t+3;q++){for(var p=0;6>p;p++){m(r.$,"#"+f[q]+f[p]+f[o])}}}}function m(n,p){var e=new B(n.insertCell(-1));e.setAttribute("class","ColorCell");e.setAttribute("tabIndex",-1);e.setAttribute("role","gridcell");e.on("keydown",a);e.on("click",s);e.on("focus",i);e.on("blur",C);e.setStyle("background-color",p);e.setStyle("border","1px solid "+p);e.setStyle("width","14px");e.setStyle("height","14px");var o=G("color_table_cell");e.setAttribute("aria-labelledby",o);e.append(CKEDITOR.dom.element.createFromHtml('<span id="'+o+'" class="cke_voice_label">'+p+"</span>",CKEDITOR.document))}K=CKEDITOR.dom.element.createFromHtml('<table tabIndex="-1" aria-label="'+L.options+'" role="grid" style="border-collapse:separate;" cellspacing="0"><caption class="cke_voice_label">'+L.options+'</caption><tbody role="presentation"></tbody></table>');K.on("mouseover",i);K.on("mouseout",C);var f="00 33 66 99 cc ff".split(" ");h(0,0);h(3,0);h(0,3);h(3,3);var l=new B(K.$.insertRow(-1));l.setAttribute("role","row");m(l.$,"#000000");for(var k=0;16>k;k++){var j=k.toString(16);m(l.$,"#"+j+j+j+j+j+j)}m(l.$,"#ffffff")})();return{title:L.title,minWidth:360,minHeight:220,onLoad:function(){D=this},onHide:function(){F();var d=M.getChild(0).getHtml();M.setStyle("border-color",d);M.setStyle("border-style","solid");N.getById(I).removeStyle("background-color");N.getById(H).setHtml("&nbsp;");M=null},contents:[{id:"picker",label:L.title,accessKey:"I",elements:[{type:"hbox",padding:0,widths:["70%","10%","30%"],children:[{type:"html",html:"<div></div>",onLoad:function(){CKEDITOR.document.getById(this.domId).append(K)},focus:function(){(M||this.getElement().getElementsByTag("td").getItem(0)).focus()}},c,{type:"vbox",padding:0,widths:["70%","5%","25%"],children:[{type:"html",html:"<span>"+L.highlight+'</span><div id="'+I+'" style="border: 1px solid; height: 74px; width: 74px;"></div><div id="'+H+'">&nbsp;</div><span>'+L.selected+'</span><div id="'+E+'" style="border: 1px solid; height: 20px; width: 74px;"></div>'},{type:"text",label:L.selected,labelStyle:"display:none",id:"selectedColor",style:"width: 76px;margin-top:4px",onChange:function(){try{N.getById(E).setStyle("background-color",this.getValue())}catch(d){F()}}},c,{type:"button",id:"clear",label:L.clear,onClick:F}]}]}]}]}});