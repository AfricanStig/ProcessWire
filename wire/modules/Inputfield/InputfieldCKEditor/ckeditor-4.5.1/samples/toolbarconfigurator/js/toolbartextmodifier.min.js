(function(){function c(d){a.call(this,d);this.hintContainer=this.codeContainer=null}var a=ToolbarConfigurator.AbstractToolbarModifier,b=ToolbarConfigurator.FullToolbarEditor;ToolbarConfigurator.ToolbarTextModifier=c;c.prototype=Object.create(a.prototype);c.prototype._onInit=function(e,f){a.prototype._onInit.call(this,void 0,f);this._createModifier(f?this.actualConfig:void 0);"function"===typeof e&&e(this.mainContainer)};c.prototype._createModifier=function(h){function m(i){var f=n(i);if(null!==f.charsBetween){var q=j.getUnusedButtonsArray(j.actualConfig.toolbar,!0,f.charsBetween),p=i.getCursor(),f=CodeMirror.Pos(p.line,p.ch-f.charsBetween.length),o=i.getTokenAt(p);"{"===i.getTokenAt({line:p.line,ch:o.start}).string&&(q=["name"]);if(0!==q.length){return new k(f,p,q)}}}function k(e,f,d){this.from=e;this.to=f;this.list=d;this._handlers=[]}function n(f,o){var e={};e.cur=f.getCursor();e.tok=f.getTokenAt(e.cur);e["char"]=o||e.tok.string.charAt(e.tok.string.length-1);var i=f.getRange(CodeMirror.Pos(e.cur.line,0),e.cur).split("").reverse().join(""),i=i.replace(/(['|"]\w*['|"])/g,"");e.charsBetween=i.match(/(^\w*)(['|"])/);e.charsBetween&&(e.endChar=e.charsBetween[2],e.charsBetween=e.charsBetween[1].split("").reverse().join(""));return e}function g(d){setTimeout(function(){d.state.completionActive||CodeMirror.showHint(d,m,{hintsClass:"toolbar-modifier",completeSingle:!1})},100);return CodeMirror.Pass}var j=this;this._createToolbar();this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer);a.prototype._createModifier.call(this);this._setupActualConfig(h);var h=this.actualConfig.toolbar,h=CKEDITOR.tools.isArray(h)?"\tconfig.toolbar = "+("[\n\t\t"+b.map(h,function(d){return a.stringifyJSONintoOneLine(d,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar = [];",h=["CKEDITOR.editorConfig = function( config ) {\n",h,"\n};"].join(""),l=new CKEDITOR.dom.element("div");l.addClass("codemirror-wrapper");this.modifyContainer.append(l);this.codeContainer=CodeMirror(l.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:Infinity,value:h,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:g,Right:g,"'''":g,"'\"'":g,Backspace:g,Delete:g,"Shift-Tab":"indentLess"}});this.codeContainer.on("endCompletion",function(f,e){var i=n(f);void 0!==e&&f.replaceSelection(i.endChar)});this.codeContainer.on("change",function(){var d=j.codeContainer.getValue(),d=j._evaluateValue(d);null!==d?(j.actualConfig.toolbar=d.toolbar?d.toolbar:j.actualConfig.toolbar,j._fillHintByUnusedElements(),j._refreshEditor(),j.mainContainer.removeClass("invalid")):j.mainContainer.addClass("invalid")});this.hintContainer=new CKEDITOR.dom.element("div");this.hintContainer.addClass("toolbarModifier-hints");this._fillHintByUnusedElements();this.hintContainer.insertBefore(l)};c.prototype._fillHintByUnusedElements=function(){var e=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),e=this.groupButtonNamesByGroup(e),h=b.map(e,function(f){var d=b.map(f.buttons,function(i){return"<code>"+i+"</code> "}).join("");return["<dt><code>",f.name,"</code></dt><dd>",d,"</dd>"].join("")}).join(" "),g='<dt class="list-header">Toolbar group</dt><dd class="list-header">Unused items</dd>';e.length||(g="<p>All items are in use.</p>");this.codeContainer.refresh();this.hintContainer.setHtml("<h3>Unused toolbar items</h3><dl>"+g+h+"</dl>")};c.prototype.getToolbarGroupByButtonName=function(g){var i=this.fullToolbarEditor.buttonNamesByGroup,h;for(h in i){for(var j=i[h],e=j.length;e--;){if(g===j[e]){return h}}}return null};c.prototype.getUnusedButtonsArray=function(e,h,g){var h=!0===h?!0:!1,i=c.mapToolbarCfgToElementsList(e),e=Object.keys(this.fullToolbarEditor.editorInstance.ui.items),e=b.filter(e,function(f){var j="-"===f,f=void 0===g||0===f.toLowerCase().indexOf(g.toLowerCase());return !j&&f}),e=b.filter(e,function(d){return -1==CKEDITOR.tools.indexOf(i,d)});h&&e.sort();return e};c.prototype.groupButtonNamesByGroup=function(g){var i=[],h=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup)),j;for(j in h){var e=h[j],e=b.filter(e,function(d){return -1!==CKEDITOR.tools.indexOf(g,d)});e.length&&i.push({name:j,buttons:e})}return i};c.mapToolbarCfgToElementsList=function(g){function i(d){return"-"!==d}for(var h=[],j=g.length,e=0;e<j;e+=1){g[e]&&"string"!==typeof g[e]&&(h=h.concat(b.filter(g[e].items,i)))}return h};c.prototype._setupActualConfig=function(d){d=d||this.editorInstance.config;CKEDITOR.tools.isArray(d.toolbar)||(d.toolbarGroups||(d.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(d),d.toolbar=this._mapToolbarGroupsToToolbar(d.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=d.toolbar,this.actualConfig.removeButtons="")};c.prototype._mapToolbarGroupsToToolbar=function(e,h){for(var h=h||this.editorInstance.config.removedBtns,h="string"==typeof h?h.split(","):[],g=e.length;g--;){var i=this._mapToolbarSubgroup(e[g],h);"separator"===e[g].type?e[g]="/":CKEDITOR.tools.isArray(i)&&0===i.length?e.splice(g,1):e[g]="string"==typeof i?i:{name:e[g].name,items:i}}return e};c.prototype._mapToolbarSubgroup=function(i,m){if("string"==typeof i){return i}for(var k=i.groups?i.groups.length:0,n=[],h=0;h<k;h+=1){var l=i.groups[h],l=this.fullToolbarEditor.buttonsByGroup["string"===typeof l?l:l.name]||[],l=this._mapButtonsToButtonsNames(l,m),j=l.length,n=n.concat(l);j&&n.push("-")}"-"==n[n.length-1]&&n.pop();return n};c.prototype._mapButtonsToButtonsNames=function(e,h){for(var g=e.length;g--;){var i=e[g],i="string"===typeof i?i:this.fullToolbarEditor.getCamelCasedButtonName(i.name);-1!==CKEDITOR.tools.indexOf(h,i)?e.splice(g,1):e[g]=i}return e};c.prototype._evaluateValue=function(g){var i;try{var h={};Function("var CKEDITOR = {}; "+g+"; return CKEDITOR;")().editorConfig(h);i=h;for(var j=i.toolbar.length;j--;){i.toolbar[j]||i.toolbar.splice(j,1)}}catch(e){i=null}return i};c.prototype.mapToolbarToToolbarGroups=function(x){function u(f,e){for(var f=f.slice(),g=e.length;g--;){var h=f.indexOf(e[g]);-1!==h&&f.splice(h,1)}return f}for(var s={},v=[],w=[],v=x.length,t=0;t<v;t++){if("/"===x[t]){w.push("/")}else{var r=x[t].items,o={};o.name=x[t].name;o.groups=[];for(var p=r.length,i=0;i<p;i++){var n=r[i];if("-"!==n){var q=this.getToolbarGroupByButtonName(n);-1===o.groups.indexOf(q)&&o.groups.push(q);s[q]=s[q]||{};q=s[q].buttons=s[q].buttons||{};q[n]=q[n]||{used:0,origin:o.name};q[n].used++}}w.push(o)}}v=function(h,d){var m=[],l;for(l in h){var k=h[l],j=d[l].slice(),m=m.concat(u(j,Object.keys(k.buttons)))}return m}(s,this.fullToolbarEditor.buttonNamesByGroup);return{toolbarGroups:w,removeButtons:v.join(",")}};return c})();